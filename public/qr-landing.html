<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VideoPortero - Bienvenido</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #7d1522 0%, #3d3d3d 100%);
        color: white;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 20% 80%,
            rgba(255, 255, 255, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(255, 255, 255, 0.05) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }

      .container {
        max-width: 500px;
        width: 100%;
        text-align: center;
        position: relative;
        z-index: 1;
      }

      .logo-container {
        margin: 30px 0;
        position: relative;
      }

      .logo {
        font-size: 2.8rem;
        font-weight: bold;
        color: #ffcc00;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        display: inline-block;
        padding: 10px 20px;
        border-radius: 20px;
        background: rgba(255, 204, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 204, 0, 0.3);
      }

      .logo::before {
        content: "üö™";
        margin-right: 10px;
      }

      .host-info {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      .host-info:hover {
        transform: translateY(-5px);
      }

      .host-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #ffcc00;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .host-name {
        font-size: 1.8rem;
        margin-bottom: 10px;
        color: #ffcc00;
        font-weight: 600;
      }

      .welcome-text {
        font-size: 1.3rem;
        margin-bottom: 40px;
        opacity: 0.9;
        line-height: 1.6;
        padding: 0 10px;
      }

      .welcome-text::after {
        content: "";
        display: block;
        width: 60px;
        height: 3px;
        background: #ffcc00;
        margin: 20px auto;
        border-radius: 2px;
      }

      .options-title {
        font-size: 1.4rem;
        margin-bottom: 25px;
        color: #ffcc00;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .options-container {
        display: flex;
        flex-direction: column;
        gap: 25px;
        margin-bottom: 40px;
      }

      .option-card {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        border-radius: 20px;
        padding: 30px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 2px solid transparent;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 25px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .option-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          currentColor 50%,
          transparent 100%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .option-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
      }

      .option-card:hover::before {
        opacity: 1;
      }

      .option-card.call {
        border-color: #28a745;
        color: #28a745;
      }

      .option-card.call:hover {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.1) 0%,
          rgba(255, 255, 255, 0.95) 100%
        );
      }

      .option-card.message {
        border-color: #17a2b8;
        color: #17a2b8;
      }

      .option-card.message:hover {
        background: linear-gradient(
          135deg,
          rgba(23, 162, 184, 0.1) 0%,
          rgba(255, 255, 255, 0.95) 100%
        );
      }

      .option-icon {
        font-size: 3.5rem;
        flex-shrink: 0;
        transition: transform 0.3s ease;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }

      .option-card:hover .option-icon {
        transform: scale(1.1) rotate(5deg);
      }

      .option-content {
        flex-grow: 1;
      }

      .option-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 8px;
        color: #7d1522;
      }

      .option-description {
        color: #666;
        font-size: 1rem;
        line-height: 1.5;
      }

      .option-badge {
        position: absolute;
        top: -10px;
        right: 20px;
        background: currentColor;
        color: white;
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      }

      /* Nuevo formulario para datos del visitante */
      .guest-form {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        border-radius: 20px;
        padding: 30px;
        margin-top: 20px;
        animation: slideUp 0.3s ease-out;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 2px solid #17a2b8;
        display: none;
      }

      .form-title {
        font-size: 1.5rem;
        margin-bottom: 25px;
        color: #7d1522;
        text-align: center;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 1rem;
      }

      .form-group.required label::after {
        content: " *";
        color: #dc3545;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #17a2b8;
        box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.2);
      }

      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: #aaa;
        font-style: italic;
      }

      .form-group input.error,
      .form-group textarea.error {
        border-color: #dc3545;
      }

      .error-text {
        color: #dc3545;
        font-size: 0.85rem;
        margin-top: 5px;
        display: none;
      }

      .char-counter {
        text-align: right;
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
      }

      .char-counter.warning {
        color: #ff9800;
        font-weight: bold;
      }

      .char-counter.error {
        color: #dc3545;
        font-weight: bold;
      }

      .form-buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 25px;
      }

      .message-box {
        display: none;
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        border-radius: 20px;
        padding: 30px;
        margin-top: 20px;
        animation: slideUp 0.3s ease-out;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 2px solid #17a2b8;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-title {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: #7d1522;
        text-align: center;
        font-weight: 600;
      }

      .message-box textarea {
        width: 100%;
        height: 150px;
        padding: 20px;
        border: 2px solid #ddd;
        border-radius: 15px;
        font-size: 1.1rem;
        resize: vertical;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        line-height: 1.5;
        background: rgba(255, 255, 255, 0.9);
      }

      .message-box textarea:focus {
        outline: none;
        border-color: #17a2b8;
        box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.2);
        background: white;
      }

      .message-box textarea::placeholder {
        color: #aaa;
        font-style: italic;
      }

      .message-examples {
        background: rgba(23, 162, 184, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: left;
      }

      .message-examples h4 {
        color: #17a2b8;
        margin-bottom: 10px;
        font-size: 1rem;
      }

      .message-examples ul {
        list-style: none;
        padding-left: 0;
      }

      .message-examples li {
        padding: 5px 0;
        color: #666;
        font-size: 0.9rem;
        border-bottom: 1px solid rgba(23, 162, 184, 0.2);
      }

      .message-examples li:last-child {
        border-bottom: none;
      }

      .message-examples li::before {
        content: "üí° ";
      }

      .buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
      }

      .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        min-width: 140px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-primary {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        color: white;
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
      }

      .btn-icon {
        font-size: 1.2rem;
      }

      .status-message {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 15px;
        padding: 20px;
        margin-top: 25px;
        display: none;
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .status-message.success {
        background: rgba(40, 167, 69, 0.2);
        border-left: 5px solid #28a745;
        color: #d4edda;
      }

      .status-message.error {
        background: rgba(220, 53, 69, 0.2);
        border-left: 5px solid #dc3545;
        color: #f8d7da;
      }

      .status-message.info {
        background: rgba(23, 162, 184, 0.2);
        border-left: 5px solid #17a2b8;
        color: #d1ecf1;
      }

      .status-message.warning {
        background: rgba(255, 193, 7, 0.2);
        border-left: 5px solid #ffc107;
        color: #fff3cd;
      }

      .status-content {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .status-icon {
        font-size: 2rem;
      }

      .status-text {
        flex-grow: 1;
        text-align: left;
      }

      .status-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .status-description {
        font-size: 1rem;
        opacity: 0.9;
      }

      .loading {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #ffcc00;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .pulse {
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.9rem;
        opacity: 0.7;
        text-align: center;
        width: 100%;
      }

      .connection-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 100;
      }

      .connection-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #dc3545;
      }

      .connection-dot.connected {
        background: #28a745;
        animation: pulse 2s infinite;
      }

      @media (max-width: 600px) {
        .container {
          padding: 0 15px;
        }

        .logo {
          font-size: 2.2rem;
          padding: 8px 16px;
        }

        .host-info {
          padding: 20px;
        }

        .option-card {
          padding: 20px;
          flex-direction: column;
          text-align: center;
          gap: 15px;
        }

        .option-icon {
          font-size: 3rem;
        }

        .guest-form,
        .message-box {
          padding: 20px;
        }

        .form-buttons,
        .buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo-container">
        <div class="logo">VideoPortero</div>
      </div>

      <div class="host-info">
        <div class="host-icon">üè†</div>
        <div class="host-name" id="hostName">
          Cargando informaci√≥n del host...
        </div>
        <div>Has escaneado el c√≥digo QR de este anfitri√≥n</div>
      </div>

      <div class="welcome-text">
        Selecciona c√≥mo te gustar√≠a contactar con el anfitri√≥n
      </div>

      <div class="options-title">Elige una opci√≥n</div>

      <div class="options-container" id="optionsContainer">
        <div class="option-card call" onclick="selectOption('call')">
          <div class="option-icon">üìû</div>
          <div class="option-content">
            <div class="option-title">Realizar Videollamada</div>
            <div class="option-description">
              Inicia una videollamada en directo con el anfitri√≥n. Su tel√©fono
              sonar√° y vibrar√° inmediatamente para notificarle.
            </div>
          </div>
          <div class="option-badge">Inmediato</div>
        </div>

        <div class="option-card message" onclick="selectOption('message')">
          <div class="option-icon">üìù</div>
          <div class="option-content">
            <div class="option-title">Enviar Mensaje</div>
            <div class="option-description">
              Env√≠a un mensaje al anfitri√≥n. Su tel√©fono notificar√° primero,
              luego podr√°s escribir tu mensaje completo.
            </div>
          </div>
          <div class="option-badge">2 Pasos</div>
        </div>
      </div>

      <!-- Formulario para datos del visitante -->
      <!-- Formulario para datos del visitante -->
      <div class="guest-form" id="guestForm">
        <div class="form-title">üë§ Tu informaci√≥n</div>

        <div class="form-group required">
          <label for="guestName">Tu nombre (opcional)</label>
          <input type="text" id="guestName" placeholder="¬øC√≥mo te llamas?" />
          <div class="error-text" id="nameError">
            Por favor, ingresa un nombre v√°lido
          </div>
        </div>

        <!-- ELIMINAR: Campos de email, tel√©fono y empresa -->

        <div class="form-group" id="messageGroup" style="display: none">
          <label for="guestMessage" class="required">Tu mensaje</label>
          <textarea
            id="guestMessage"
            placeholder="Escribe tu mensaje aqu√≠..."
            rows="4"
          ></textarea>
          <div class="char-counter" id="messageCharCounter">
            <span id="messageCharCount">0</span> / 500 caracteres
          </div>
          <div class="error-text" id="messageError">
            Por favor, escribe un mensaje
          </div>

          <div class="message-examples">
            <h4>Ejemplos de mensajes:</h4>
            <ul>
              <li>Hola, estoy en la puerta principal.</li>
              <li>Tengo un paquete para entregar.</li>
              <li>Necesito hablar contigo sobre un asunto urgente.</li>
              <li>¬øPodr√≠as venir a recibirme, por favor?</li>
            </ul>
          </div>
        </div>

        <div class="form-buttons">
          <button class="btn btn-secondary" onclick="cancelForm()">
            <span class="btn-icon">‚Ü©Ô∏è</span>
            <span>Cancelar</span>
          </button>
          <button class="btn btn-primary" onclick="submitGuestData()">
            <span class="btn-icon">üì§</span>
            <span id="submitButtonText">Continuar</span>
          </button>
        </div>
      </div>

      <!-- Caja de mensaje antiguo (para compatibilidad an√≥nima) -->
      <div class="message-box" id="messageBox">
        <div class="message-title">üìù Escribe tu mensaje</div>

        <div class="message-examples">
          <h4>Ejemplos de mensajes:</h4>
          <ul>
            <li>Hola, estoy en la puerta principal.</li>
            <li>Tengo un paquete para entregar.</li>
            <li>Necesito hablar contigo sobre un asunto urgente.</li>
            <li>¬øPodr√≠as venir a recibirme, por favor?</li>
          </ul>
        </div>

        <textarea
          id="messageText"
          placeholder="Escribe tu mensaje aqu√≠...
                    
Ejemplo: Hola, soy [tu nombre]. [Explica brevemente tu motivo].
                    
M√°ximo 500 caracteres."
          maxlength="500"
        ></textarea>

        <div class="char-counter" id="charCounter">
          <span id="charCount">0</span> / 500 caracteres
        </div>

        <div class="buttons">
          <button class="btn btn-secondary" onclick="cancelMessage()">
            <span class="btn-icon">‚Ü©Ô∏è</span>
            <span>Volver</span>
          </button>
          <button class="btn btn-primary" onclick="sendMessage()">
            <span class="btn-icon">üì§</span>
            <span>Enviar Mensaje</span>
          </button>
        </div>
      </div>

      <div class="status-message" id="statusMessage">
        <div class="status-content">
          <div class="status-icon" id="statusIcon">‚è≥</div>
          <div class="status-text">
            <div class="status-title" id="statusTitle">Procesando</div>
            <div class="status-description" id="statusDescription"></div>
          </div>
          <div class="loading" id="statusLoading" style="display: none"></div>
        </div>
      </div>

      <div class="footer">
        VideoPortero ¬© 2024 - Sistema de videollamadas seguro
      </div>
    </div>

    <div class="connection-status" id="connectionStatus">
      <div class="connection-dot" id="connectionDot"></div>
      <span id="connectionText">Conectando...</span>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Variables globales
      let selectedAction = null;
      let callId = null;
      let hostId = null;
      let hostName = null;
      let socket = null;
      let isConnected = false;
      let guestData = {};
      let responseTimeout = null;

      // Obtener c√≥digo QR de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const qrCode = urlParams.get("code");

      // Elementos del DOM
      const hostNameEl = document.getElementById("hostName");
      const optionsContainer = document.getElementById("optionsContainer");
      const guestForm = document.getElementById("guestForm");
      const messageGroup = document.getElementById("messageGroup");
      const guestNameInput = document.getElementById("guestName");
      //   const guestEmailInput = document.getElementById("guestEmail");
      //   const guestPhoneInput = document.getElementById("guestPhone");
      //   const guestCompanyInput = document.getElementById("guestCompany");
      const guestMessageInput = document.getElementById("guestMessage");
      const messageCharCount = document.getElementById("messageCharCount");
      const submitButtonText = document.getElementById("submitButtonText");
      const messageBox = document.getElementById("messageBox");
      const messageText = document.getElementById("messageText");
      const charCounter = document.getElementById("charCounter");
      const charCount = document.getElementById("charCount");
      const statusMessage = document.getElementById("statusMessage");
      const statusIcon = document.getElementById("statusIcon");
      const statusTitle = document.getElementById("statusTitle");
      const statusDescription = document.getElementById("statusDescription");
      const statusLoading = document.getElementById("statusLoading");
      const connectionStatus = document.getElementById("connectionStatus");
      const connectionDot = document.getElementById("connectionDot");
      const connectionText = document.getElementById("connectionText");

      // Errores
      const nameError = document.getElementById("nameError");
      //   const emailError = document.getElementById("emailError");
      const messageError = document.getElementById("messageError");

      // Inicializar
      document.addEventListener("DOMContentLoaded", () => {
        if (!qrCode) {
          showError(
            "No se encontr√≥ c√≥digo QR en la URL. Por favor, escanea el c√≥digo QR nuevamente."
          );
          return;
        }

        loadHostInfo();
        setupEventListeners();
      });

      // Configurar event listeners
      function setupEventListeners() {
        if (guestMessageInput) {
          guestMessageInput.addEventListener("input", () => {
            const length = guestMessageInput.value.length;
            messageCharCount.textContent = length;
          });
        }

        if (messageText) {
          messageText.addEventListener("input", () => {
            const length = messageText.value.length;
            charCount.textContent = length;
          });
        }

        guestNameInput.addEventListener("blur", validateName);
        // guestEmailInput.addEventListener("blur", validateEmail);
        guestMessageInput.addEventListener("blur", validateMessage);

        guestNameInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") guestEmailInput.focus();
        });

        guestEmailInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            if (selectedAction === "message") guestMessageInput.focus();
            else submitGuestData();
          }
        });

        guestMessageInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && e.ctrlKey) submitGuestData();
        });
      }

      // Validaciones
      function validateName() {
        const name = guestNameInput.value.trim();
        if (!name) {
          guestNameInput.classList.add("error");
          nameError.style.display = "block";
          return false;
        }
        guestNameInput.classList.remove("error");
        nameError.style.display = "none";
        return true;
      }

      //   function validateEmail() {
      //     const email = guestEmailInput.value.trim();
      //     const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      //     if (!email || !emailRegex.test(email)) {
      //       guestEmailInput.classList.add("error");
      //       emailError.style.display = "block";
      //       return false;
      //     }
      //     guestEmailInput.classList.remove("error");
      //     emailError.style.display = "none";
      //     return true;
      //   }

      function validateMessage() {
        if (selectedAction !== "message") return true;
        const message = guestMessageInput.value.trim();
        if (!message) {
          guestMessageInput.classList.add("error");
          messageError.style.display = "block";
          return false;
        }
        guestMessageInput.classList.remove("error");
        messageError.style.display = "none";
        return true;
      }

      // Cargar informaci√≥n del host
      async function loadHostInfo() {
        showInfo("Conectando con el servidor...", true);

        try {
          const response = await fetch(`/auth/host-by-qr/${qrCode}`);
          if (!response.ok) throw new Error("Host no encontrado");

          const data = await response.json();
          if (data.success) {
            hostId = data.host.id;
            hostName = data.host.name;
            hostNameEl.textContent = hostName;
            connectWebSocket();
          } else {
            throw new Error(data.error);
          }
        } catch (error) {
          showError(`‚ùå ${error.message}`);
        }
      }

      // Conectar WebSocket
      function connectWebSocket() {
        const socketUrl = window.location.origin;

        socket = io(socketUrl, {
          transports: ["websocket", "polling"],
          reconnectionAttempts: 10,
          reconnectionDelay: 1000,
        });

        socket.on("connect", () => {
          console.log("‚úÖ WebSocket conectado");
          isConnected = true;
          updateConnectionStatus(true);
        });

        socket.on("connect_error", (err) => {
          console.error("Error WebSocket:", err);
          isConnected = false;
          updateConnectionStatus(false);
        });

        socket.on("disconnect", () => {
          isConnected = false;
          updateConnectionStatus(false);
        });

        // === EVENTOS EN TIEMPO REAL PARA EL GUEST ===
        socket.on("flow-response", (data) => {
          if (data.callId !== callId) return;

          clearTimeout(responseTimeout);

          if (data.response === "accept") {
            if (selectedAction === "call") {
              showSuccess("‚úÖ El anfitri√≥n acept√≥ la videollamada", false);
              setTimeout(() => {
                // ABRIR EN NUEVA PESTA√ëA ‚Üí NO RECARGA ESTA P√ÅGINA ‚Üí NO SE DESCONECTA
                window.open(`/videocall/web?callId=${callId}`, "_blank");
                showInfo(
                  "üìπ Videollamada abierta en nueva pesta√±a. Puedes cerrar esta cuando quieras.",
                  false
                );
              }, 1500);
            } else {
              showSuccess("‚úÖ Mensaje entregado", false);
              if (data.hostMessage) {
                showInfo(
                  `üí¨ Respuesta del anfitri√≥n: ${data.hostMessage}`,
                  false
                );
              }
              setTimeout(resetInterface, 4000);
            }
          } else {
            showError("‚ùå El anfitri√≥n no puede atender ahora");
            setTimeout(resetInterface, 4000);
          }
        });

        socket.on("flow-host-accepted", (data) => {
          if (data.callId === callId) {
            showSuccess("‚úÖ Videollamada aceptada", false);
            setTimeout(() => {
              window.open(`/videocall/web?callId=${callId}`, "_blank");
              showInfo("üìπ Videollamada abierta en nueva pesta√±a.", false);
            }, 1000);
          }
        });

        socket.on("flow-cancelled", () => {
          clearTimeout(responseTimeout);
          showError("‚è∞ Tiempo agotado");
          setTimeout(resetInterface, 3000);
        });
      }

      function updateConnectionStatus(connected) {
        if (connected) {
          connectionDot.className = "connection-dot connected";
          connectionText.textContent = "Conectado";
        } else {
          connectionDot.className = "connection-dot";
          connectionText.textContent = "Desconectado";
        }
      }

      // Seleccionar opci√≥n
      function selectOption(action) {
        if (!isConnected) {
          showError("‚ö†Ô∏è No hay conexi√≥n con el servidor.");
          return;
        }

        selectedAction = action;
        guestForm.style.display = "block";
        optionsContainer.style.display = "none";

        if (action === "message") {
          messageGroup.style.display = "block";
          submitButtonText.textContent = "Enviar Mensaje";
        } else {
          messageGroup.style.display = "none";
          submitButtonText.textContent = "Realizar Videollamada";
        }

        setTimeout(() => guestNameInput.focus(), 100);
      }

      function cancelForm() {
        guestForm.style.display = "none";
        optionsContainer.style.display = "flex";
        resetForm();
        selectedAction = null;
      }

      function resetForm() {
        guestNameInput.value = "";
        guestEmailInput.value = "";
        guestPhoneInput.value = "";
        guestCompanyInput.value = "";
        guestMessageInput.value = "";

        guestNameInput.classList.remove("error");
        guestEmailInput.classList.remove("error");
        guestMessageInput.classList.remove("error");
        nameError.style.display = "none";
        emailError.style.display = "none";
        messageError.style.display = "none";

        messageCharCount.textContent = "0";
      }

      // Enviar datos
      async function submitGuestData() {
        const isMessageValid =
          selectedAction === "message" ? validateMessage() : true;

        if (!isMessageValid) {
          showError("Por favor, escribe un mensaje");
          return;
        }

        guestData = {
          name: guestNameInput.value.trim() || "Visitante", // Nombre opcional
          message:
            selectedAction === "message"
              ? guestMessageInput.value.trim()
              : null,
        };

        showInfo(
          selectedAction === "call"
            ? "üìû Llamando..."
            : "üìù Enviando mensaje...",
          true
        );
        guestForm.style.display = "none";

        try {
          await startFlowWithGuestData();
        } catch (error) {
          showError("Error al procesar la solicitud");
          guestForm.style.display = "block";
        }
      }

      // Iniciar flujo
      async function startFlowWithGuestData() {
        const requestData = {
          qrCode,
          actionType: selectedAction,
          guestName: guestData.name,
          message: guestData.message,
          isAnonymous: guestData.name === "Visitante",
        };

        const response = await fetch("/flows/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestData),
        });

        const data = await response.json();

        if (data.success) {
          callId = data.callId;

          // Unirse a la sala del flujo
          socket.emit("join-flow-room", { callId });

          showInfo(
            selectedAction === "call"
              ? "üìû Llamando... Esperando respuesta del anfitri√≥n"
              : "üìù Mensaje enviado. Esperando respuesta...",
            false
          );

          // Timeout de seguridad
          responseTimeout = setTimeout(() => {
            showError("‚è∞ No hubo respuesta del anfitri√≥n");
            setTimeout(resetInterface, 3000);
          }, 90000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      }

      // Compatibilidad modo an√≥nimo
      function cancelMessage() {
        messageBox.style.display = "none";
        optionsContainer.style.display = "flex";
        messageText.value = "";
        charCount.textContent = "0";
        selectedAction = null;
      }

      async function sendMessage() {
        const message = messageText.value.trim();
        if (!message || message.length < 5 || message.length > 500) {
          showError("Mensaje inv√°lido");
          return;
        }

        guestData = {
          name: "Visitante Web",
          email: "anonimo@visitante.com",
          phone: null,
          company: null,
          message,
        };

        selectedAction = "message";
        showInfo("üìù Enviando mensaje...", true);
        messageBox.style.display = "none";

        try {
          await startFlowWithGuestData();
        } catch (error) {
          showError("Error enviando mensaje");
          messageBox.style.display = "block";
        }
      }

      // Reiniciar interfaz
      function resetInterface() {
        clearTimeout(responseTimeout);
        selectedAction = null;
        callId = null;
        guestData = {};

        guestForm.style.display = "none";
        messageBox.style.display = "none";
        optionsContainer.style.display = "flex";
        hideStatus();
        resetForm();
      }

      // Mensajes de estado
      function showInfo(message, loading = false) {
        statusMessage.className = "status-message info";
        statusIcon.textContent = "‚ÑπÔ∏è";
        statusTitle.textContent = "Informaci√≥n";
        statusDescription.textContent = message;
        statusLoading.style.display = loading ? "inline-block" : "none";
        statusMessage.style.display = "block";
      }

      function showSuccess(message, loading = false) {
        statusMessage.className = "status-message success";
        statusIcon.textContent = "‚úÖ";
        statusTitle.textContent = "√âxito";
        statusDescription.textContent = message;
        statusLoading.style.display = loading ? "inline-block" : "none";
        statusMessage.style.display = "block";
      }

      function showError(message) {
        statusMessage.className = "status-message error";
        statusIcon.textContent = "‚ùå";
        statusTitle.textContent = "Error";
        statusDescription.textContent = message;
        statusLoading.style.display = "none";
        statusMessage.style.display = "block";
      }

      function hideStatus() {
        statusMessage.style.display = "none";
      }

      // Advertencia al salir
      window.addEventListener("beforeunload", (e) => {
        if (callId && selectedAction === "call") {
          e.preventDefault();
          e.returnValue = "";
        }
      });
    </script>
  </body>
</html>
