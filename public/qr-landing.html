<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Videollamada Directa</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #7d1522, #3d3d3d);
        color: white;
        text-align: center;
        padding: 20px;
        min-height: 100vh;
      }
      .container { max-width: 100%; }
      h1 { margin: 20px 0; font-size: 24px; }
      .video-container {
        display: flex; flex-wrap: wrap; justify-content: center;
        gap: 20px; margin: 20px 0;
      }
      video {
        width: 100%; max-width: 400px; height: 300px;
        border-radius: 15px; background: #000;
        transform: scaleX(-1); object-fit: cover;
      }
      .button {
        background: #faffff; color: #7d1522; border: none;
        padding: 15px 30px; font-size: 18px; border-radius: 10px;
        cursor: pointer; margin: 10px; font-weight: bold;
      }
      .end-call { background: #dc3545; color: white; }
      .status {
        margin: 20px 0; padding: 15px; border-radius: 10px;
        background: rgba(255, 255, 255, 0.2); font-size: 16px;
      }
      .notification-badge {
        background: #28a745; color: white; padding: 10px 15px;
        border-radius: 20px; margin: 10px 0; display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Videollamada Directa</h1>
      <div id="notificationStatus" class="notification-badge" style="display: none">
        Llamando...
      </div>
      <div id="status" class="status">Iniciando...</div>
      <div class="video-container">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
      <button id="endCallButton" class="button end-call" style="display: none">
        Colgar Llamada
      </button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const status = document.getElementById("status");
      const notificationStatus = document.getElementById("notificationStatus");
      const endCallButton = document.getElementById("endCallButton");

      let localStream = null;
      let peerConnection = null;
      let socket = null;
      let callId = null;

      const pcConfig = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
        ],
      };

      window.addEventListener("load", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const qrCode = urlParams.get("code");
        if (!qrCode) return status.textContent = "Error: No hay código";

        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
            audio: true
          });
          localVideo.srcObject = localStream;

          socket = io("https://videoporteroqr-back.onrender.com", {
            transports: ["websocket"]
          });

          // LLAMADA AL BACKEND → nos devuelve el callId correcto (que es el qrCode)
          const res = await fetch("/videocall/anonymous-call", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ qrCode, guestName: "Visitante Web" })
          });

          const data = await res.json();
          if (!data.success) throw new Error("No se pudo iniciar llamada");

          callId = data.callId;  // ← ESTE ES EL callId QUE USA EL HOST
          console.log("callId recibido del backend:", callId);

          notificationStatus.style.display = "block";
          notificationStatus.textContent = "Llamando al host...";

          socket.on("connect", () => {
            // Unirse a la sala con el callId correcto
            socket.emit("join-call-room", {
              callId,
              userType: "guest",
              userId: "web-" + Date.now()
            });
            initiateWebRTC();
          });

          socket.on("offer", async (offerData) => {
            if (!peerConnection) await initiateWebRTC();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit("answer", { answer, callId, userType: "guest" });
          });

          socket.on("answer", async (data) => {
            if (!peerConnection.remoteDescription) {
              await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
          });

          socket.on("ice-candidate", async (data) => {
            if (data.userType === "host" && data.candidate) {
              await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
          });

          socket.on("call-connected", () => {
            status.textContent = "Conectado!";
            endCallButton.style.display = "block";
          });

        } catch (err) {
          status.textContent = "Error: " + err.message;
        }
      });

      async function initiateWebRTC() {
        peerConnection = new RTCPeerConnection(pcConfig);
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

        peerConnection.ontrack = (e) => {
          remoteVideo.srcObject = e.streams[0];
          status.textContent = "Videollamada activa";
        };

        peerConnection.onicecandidate = (e) => {
          if (e.candidate) {
            socket.emit("ice-candidate", { candidate: e.candidate, callId, userType: "guest" });
          }
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit("offer", { offer, callId, userType: "guest" });
      }

      function endCall() {
        if (peerConnection) peerConnection.close();
        if (localStream) localStream.getTracks().forEach(t => t.stop());
        if (socket) socket.emit("end-call", { callId });
        status.textContent = "Llamada finalizada";
        setTimeout(() => window.close(), 2000);
      }

      endCallButton.onclick = endCall;
    </script>
  </body>
</html>