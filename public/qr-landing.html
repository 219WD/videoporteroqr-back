<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Videollamada Directa</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #7d1522, #3d3d3d);
        color: white;
        text-align: center;
        padding: 20px;
      }
      .container {
        max-width: 100%;
      }
      h1 {
        margin: 20px 0;
      }
      .video-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
      }
      video {
        width: 100%;
        max-width: 400px;
        height: 300px;
        border-radius: 15px;
        background: #000;
        transform: scaleX(-1); /* Espejo como en apps */
      }
      .button {
        background: #faffff;
        color: #7d1522;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 10px;
        cursor: pointer;
        margin: 10px;
        font-weight: bold;
      }
      .button:hover {
        opacity: 0.9;
      }
      .end-call {
        background: #dc3545;
        color: white;
      }
      .status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸŽ¥ Videollamada Directa</h1>

      <div id="status" class="status">Iniciando videollamada...</div>

      <div class="video-container">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>

      <button id="endCallButton" class="button end-call" style="display: none">
        ðŸ“ž Colgar Llamada
      </button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Elementos DOM
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const status = document.getElementById("status");
      const endCallButton = document.getElementById("endCallButton");

      // Variables WebRTC
      let localStream = null;
      let peerConnection = null;
      let socket = null;
      let roomId = null;

      // ConfiguraciÃ³n ICE Servers (igual que en React)
      const pcConfig = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
        ],
      };

      // Inicializar al cargar la pÃ¡gina
      window.addEventListener("load", async () => {
        await initializeCall();
      });

      async function initializeCall() {
        try {
          status.textContent = "ðŸŽ¥ Activando cÃ¡mara y micrÃ³fono...";

          // 1. Obtener cÃ³digo QR de la URL
          const urlParams = new URLSearchParams(window.location.search);
          const qrCode = urlParams.get("code");

          if (!qrCode) {
            status.textContent = "âŒ Error: CÃ³digo QR no vÃ¡lido";
            return;
          }

          roomId = qrCode; // Usamos el QR code como room ID

          // 2. Obtener stream de medios
          localStream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              facingMode: "user",
            },
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              sampleRate: 44100,
            },
          });

          // 3. Mostrar video local
          localVideo.srcObject = localStream;
          status.textContent = "âœ… CÃ¡mara activada - Conectando...";

          // 4. Conectar al servidor Socket.io
          socket = io("https://videoporteroqr-back.onrender.com", {
            transports: ["websocket"],
          });

          // 5. Configurar eventos del socket
          setupSocketEvents();

          // 6. Unirse a la sala
          socket.emit("join-room", { roomId, role: "guest" });

          // 7. Iniciar llamada despuÃ©s de 2 segundos (igual que en React)
          setTimeout(() => initiateWebRTC(), 2000);
        } catch (error) {
          console.error("Error inicial:", error);
          status.textContent = `âŒ Error: ${error.message}`;
        }
      }

      function setupSocketEvents() {
        socket.on("connect", () => {
          console.log("âœ… Conectado al servidor");
          status.textContent = "ðŸ”” Llamando al host...";
        });

        socket.on("call-accepted", () => {
          console.log("âœ… Llamada aceptada por el host");
          status.textContent = "âœ… Conectado con el host";
          endCallButton.style.display = "block";
        });

        socket.on("answer", async (data) => {
          console.log("ðŸ“¨ Answer recibido");
          if (peerConnection) {
            await peerConnection.setRemoteDescription(
              new RTCSessionDescription(data.answer)
            );
          }
        });

        socket.on("ice-candidate", async (data) => {
          console.log("ðŸ§Š ICE candidate recibido");
          if (peerConnection) {
            await peerConnection.addIceCandidate(
              new RTCIceCandidate(data.candidate)
            );
          }
        });

        socket.on("call-rejected", () => {
          status.textContent = "âŒ Llamada rechazada por el host";
          endCall();
        });

        socket.on("call-ended", () => {
          status.textContent = "ðŸ“ž Llamada finalizada por el host";
          endCall();
        });

        socket.on("disconnect", () => {
          status.textContent = "âŒ ConexiÃ³n perdida";
        });
      }

      async function initiateWebRTC() {
        try {
          status.textContent = "ðŸ”— Estableciendo conexiÃ³n WebRTC...";

          // Crear peer connection
          peerConnection = new RTCPeerConnection(pcConfig);

          // AÃ±adir stream local
          localStream.getTracks().forEach((track) => {
            peerConnection.addTrack(track, localStream);
          });

          // Manejar stream remoto
          peerConnection.ontrack = (event) => {
            console.log("ðŸ“¹ Stream remoto recibido");
            remoteVideo.srcObject = event.streams[0];
            status.textContent = "âœ… Videollamada conectada";
          };

          // Manejar ICE candidates
          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              socket.emit("ice-candidate", {
                candidate: event.candidate,
                to: roomId,
              });
            }
          };

          // Crear y enviar offer
          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);

          socket.emit("call-offer", {
            offer: offer,
            roomId: roomId,
          });

          console.log("âœ… Offer WebRTC enviado");
        } catch (error) {
          console.error("Error WebRTC:", error);
          status.textContent = "âŒ Error en conexiÃ³n WebRTC";
        }
      }

      function endCall() {
        status.textContent = "ðŸ“ž Finalizando llamada...";

        // Cerrar conexiones
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }

        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }

        if (socket) {
          socket.emit("end-call", { roomId });
          socket.disconnect();
          socket = null;
        }

        // Limpiar videos
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;

        endCallButton.style.display = "none";
        status.textContent = "Llamada finalizada";

        // Redirigir despuÃ©s de 3 segundos
        setTimeout(() => {
          window.close(); // o redirigir a otra pÃ¡gina
        }, 3000);
      }

      // Evento para el botÃ³n de colgar
      endCallButton.addEventListener("click", endCall);

      // Manejar cierre de pÃ¡gina
      window.addEventListener("beforeunload", () => {
        if (socket) {
          socket.emit("end-call", { roomId });
        }
      });
    </script>
  </body>
</html>
