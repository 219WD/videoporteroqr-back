<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videollamada - Visitante</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #localVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 3px solid white;
            border-radius: 10px;
            object-fit: cover;
            z-index: 10;
        }
        .status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 10;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 10;
        }
        .btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        .btn.end {
            background: red;
        }
    </style>
</head>
<body>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>

    <div class="status" id="status">Conectando...</div>

    <div class="controls">
        <button class="btn" id="muteBtn"></button>
        <button class="btn" id="cameraBtn"></button>
        <button class="btn end" id="endBtn"></button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const callId = urlParams.get('callId');

        if (!callId) {
            document.getElementById('status').textContent = 'Error: No se encontr贸 el ID de llamada';
            document.body.innerHTML += '<p>Cierra esta pesta帽a y vuelve a intentarlo.</p>';
            throw new Error('No callId');
        }

        const socket = io();
        let pc = null;
        let localStream = null;

        const statusEl = document.getElementById('status');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideo = document.getElementById('localVideo');

        // Unirse como guest
        socket.on('connect', () => {
            console.log('Guest conectado al servidor');
            socket.emit('join-call-room', {
                callId,
                userRole: 'guest'
            });
            statusEl.textContent = 'Esperando al anfitri贸n...';
        });

        // Iniciar c谩mara y micr贸fono
        async function startLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                statusEl.textContent = 'C谩mara lista. Esperando conexi贸n...';
            } catch (err) {
                console.error('Error c谩mara:', err);
                statusEl.textContent = 'Error: No se pudo acceder a c谩mara/mic';
            }
        }

        startLocalStream();

        // Crear conexi贸n WebRTC
        function createPeerConnection() {
            pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
                    { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
                ]
            });

            // Agregar tracks locales
            if (localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }

            pc.ontrack = (event) => {
                console.log('Recibiendo stream remoto');
                remoteVideo.srcObject = event.streams[0];
                statusEl.textContent = '隆Conectado! Videollamada en curso';
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        callId,
                        candidate: event.candidate
                    });
                }
            };

            pc.onconnectionstatechange = () => {
                console.log('Estado conexi贸n:', pc.connectionState);
                if (pc.connectionState === 'failed') {
                    statusEl.textContent = 'Conexi贸n fallida. Intenta de nuevo.';
                }
            };
        }

        // Cuando el host est谩 listo, iniciar oferta
        socket.on('host-ready', () => {
            statusEl.textContent = 'Anfitri贸n conectado. Iniciando videollamada...';
            createPeerConnection();

            // El guest inicia la oferta
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    socket.emit('call-offer', {
                        offer: pc.localDescription,
                        roomId: callId
                    });
                });
        });

        // Recibir answer del host
        socket.on('answer', (data) => {
            if (pc && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(data.answer);
            }
        });

        // ICE candidates
        socket.on('ice-candidate', (data) => {
            if (pc && data.candidate) {
                pc.addIceCandidate(data.candidate);
            }
        });

        // Finalizar llamada
        document.getElementById('endBtn').onclick = () => {
            socket.emit('end-call', { callId });
            window.close();
        };

        // Controles
        document.getElementById('muteBtn').onclick = () => {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                }
            }
        };

        document.getElementById('cameraBtn').onclick = () => {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                }
            }
        };
    </script>
</body>
</html>